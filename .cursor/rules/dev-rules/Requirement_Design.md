# 金融データトラッキングダッシュボード（vFinal）– 設計書

## 目次
1. [概要](#概要)
2. [要件](#要件)
3. [システムアーキテクチャ](#システムアーキテクチャ)
4. [技術スタック](#技術スタック)
5. [詳細設計](#詳細設計)  
   5.1 [プロジェクトセットアップ](#51-プロジェクトセットアップ)  
   5.2 [認証・ユーザー管理](#52-認証ユーザー管理)  
   5.3 [データベースとORM](#53-データベースとorm)  
   5.4 [フロントエンドUIコンポーネント](#54-フロントエンドuiコンポーネント)  
   5.5 [バックエンドデータ処理](#55-バックエンドデータ処理)  
   5.6 [Docker環境設定](#56-docker環境設定)
6. [テストと品質保証](#テストと品質保証)
7. [デプロイ戦略](#デプロイ戦略)
8. [ドキュメント・運用](#ドキュメント運用)
9. [マイルストーンとタイムライン](#マイルストーンとタイムライン)
10. [リスク考慮事項と課題](#リスク考慮事項と課題)
11. [結論](#結論)

---

## 1. 概要

この金融データトラッキングダッシュボードは、ユーザーがリアルタイムデータおよび過去のトレンドを視覚的に把握できるインタラクティブなプラットフォームを提供することを目的としています。システムは認証、外部APIからのデータ収集、UIコンポーネント、および堅牢なバックエンドデータ処理を含み、ユーザーと管理者の両方に機能的なインターフェースを提供します。

---

## 2. 要件

### 機能要件
- **ユーザー認証とロール管理:**  
  Clerkを使用してユーザー認証と（Admin / Viewer）の役割に基づくアクセス制御を実装する。
- **ダッシュボード画面:**  
  金融シンボルの一覧、sparklineチャートによる過去データの視覚化、日付範囲選択、更新ボタンによるリアルタイム更新機能を提供。
- **シンボル検索・登録:**  
  API連携によるシンボルの検索および登録機能、カテゴリ選択、ユーザーのお気に入り機能を実装する。
- **管理者パネル:**  
  シンボルの一覧表示、削除・編集、API取得履歴やログの確認、バルク操作などの管理機能を提供。
- **外部API連携:**  
  Alpha Vantage、CoinGecko、Yahoo Finance（yfinanceなど）からデータ取得を行い、データベースに整形して保存する。
- **データバリデーション:**  
  Zodを用いた入力チェックや、既存データとの重複チェックを実施する。

### 非機能要件
- **保守性と拡張性:**  
  モジュール化された設計により、将来的な機能追加や修正が容易となる。
- **パフォーマンス:**  
  ユーザーインターフェースの応答性とリアルタイム更新の効率性を確保する。
- **品質管理:**  
  ESLint、Prettier、Jest、React Testing Library、Playwrightなどのツールを使用して、高品質なコードを保つ。
- **コンテナ化:**  
  Dockerによる環境統一と、Docker Composeを利用したスムーズな開発・デプロイを実現する。
- **ドキュメント:**  
  セットアップ手順や使用方法、運用マニュアルを明確に記述する。

---

## 3. システムアーキテクチャ

- **フロントエンド:**  
  Next.js（App Router、TypeScript）をベースに、ReactとTailwind CSSを使用して開発。UIコンポーネントはRadix UI、Shadcn/ui、Lucide Reactで構成し、APIエンドポイントおよびServer Actionsを通じてバックエンドと連携する。

- **バックエンド:**  
  APIルートやServer Actionsを用いて、外部APIからのデータ取得、データの変換処理、DBへの保存、ログ管理などのビジネスロジックを実装する。

- **データベース:**  
  開発時はSQLiteを使用し、将来的にはSupabase（PostgreSQL）へ移行。Prismaを用いて、User、Symbol、Price、Favoriteの各モデルを定義する。

- **認証と認可:**  
  Clerkを利用してユーザー認証とセッション管理、ロールに基づいた保護ルートを実装する。

- **コンテナ化とデプロイ:**  
  Dockerとdocker-composeによるローカル開発環境を構築し、Vercelによってデプロイ・運用する。

---

## 4. 技術スタック

- **フロントエンド:**  
  - **フレームワーク:** Next.js (App Router, TypeScript)  
  - **スタイリング:** Tailwind CSS, tailwind-merge, tailwindcss-animate  
  - **UIライブラリ:** Radix UI, Shadcn/ui, Lucide React  

- **バックエンド & API:**  
  - **ORM:** Prisma  
  - **バリデーション:** Zod  
  - **外部API:** Alpha Vantage, CoinGecko, Yahoo Finance（yfinanceなど）  
  - **プログラミング言語:** Node.js (JavaScript/TypeScript)

- **認証:**  
  - Clerk

- **コンテナ化:**  
  - Docker, docker-compose

- **テスト:**  
  - Jest（ユニットテスト）  
  - React Testing Library（コンポーネントテスト）  
  - Playwright（E2Eテスト）

- **デプロイ:**  
  - Vercel

---

## 5. 詳細設計

### 5.1 プロジェクトセットアップ

- **初期セットアップ:**  
  - TypeScript対応のNext.jsプロジェクトを初期化する。  
  - Tailwind CSSおよび関連パッケージ（tailwind-merge、tailwindcss-animate）の設定。  
  - ESLint、Prettier、PostCSS、Autoprefixerを導入してコード品質を確保する。  
  - Dockerとdocker-composeの基本設定を構築する。

### 5.2 認証・ユーザー管理

- **Clerkの導入:**  
  - ClerkのインストールとAPIキー設定。  
  - ログイン・サインアップ画面を作成する。  
  - ユーザーのロール（Admin / Viewer）管理ロジックを実装する。  
  - 認証状態に基づいたルーティング保護（Protected Routes）を実施する。

### 5.3 データベースとORM

- **Prismaのセットアップ:**  
  - 以下のモデルを定義する:  
    - **User:** 基本的なユーザー情報とClerk識別子。  
    - **Symbol:** 金融商品の詳細情報。  
    - **Price:** 時系列の価格データ。  
    - **Favorite:** ユーザーのお気に入りシンボルとの関連付け。  
  - Prismaのマイグレーションを実行し、SQLite（開発用）で環境を構築する。  
  - Zodを使用して入力データのバリデーションを実施する。

### 5.4 フロントエンドUIコンポーネント

#### 5.4.1 ダッシュボード画面

- **主要コンポーネント:**  
  - **シンボル一覧:** 銘柄の詳細情報とsparklineチャート（例：react-sparklinesを利用）を表示。  
  - **Sparklineチャート:** 過去データを視覚化するためのチャート表示。  
  - **日付範囲セレクター:** Radix UI / ShadcnのSelectコンポーネントを使用して実装。  
  - **ローディング状態:** データ取得時のスケルトン表示を実装する。  
  - **更新ボタン:** 全体および個別のデータ更新を行い、ローディング表示を追加する。

#### 5.4.2 銘柄検索・登録画面

- **主要コンポーネント:**  
  - **検索インターフェース:** APIを利用して金融シンボルを検索する。  
  - **登録フォーム:** 新規シンボルを追加するためのフォーム（カテゴリ選択付き）。  
  - **お気に入り機能:** ユーザーがシンボルをお気に入りに追加・削除できる機能。

#### 5.4.3 管理者パネル

- **主要コンポーネント:**  
  - **シンボル管理:** 一覧表示とシンボルの削除・編集機能。  
  - **ログ管理:** API取得履歴やログを表示するダッシュボード。  
  - **一括操作:** 複数のシンボル削除やシステムリセット操作のための機能。

### 5.5 バックエンドデータ処理

- **API連携:**  
  - **Server Actions:** 更新ボタンからトリガーされるデータ取得処理を実装する。  
  - **サービスレイヤー:**  
    - Alpha Vantage、CoinGecko、Yahoo Financeからデータを取得し、正規化するためのAPIラッパーを作成する。  
    - APIレスポンスをPriceテーブルのスキーマに合わせて整形する。  
  - **データ整合性:**  
    - 重複チェックを行い、既存データとの重複を回避する。  
    - 取得結果（成功・失敗）をログに記録する。

### 5.6 Docker環境設定

- **Dockerfile:**  
  - Node.jsとnpmをインストールするためのDockerfileを作成する。  
- **docker-compose.yml:**  
  - アプリケーションの各サービス定義（ポート、ボリュームなどのマッピング）を設定する。  
- **環境変数ファイル:**  
  - `.env`ファイルを作成し、ClerkのAPIキー、データベース接続情報などを設定する。

---

## 6. テストと品質保証

- **ユニットテスト:**  
  - Jestを使用して、各コンポーネントや関数の単体テストを実施する。
- **UIテスト:**  
  - React Testing Libraryを用いて、コンポーネントのレンダリングとインタラクションをテストする。
- **エンドツーエンド（E2E）テスト:**  
  - Playwrightを活用し、ログインから更新、表示の一連のユーザーフローをシミュレーションする。
- **コード整形:**  
  - ESLintとPrettierをCIに組み込み、コードスタイルの一貫性を維持する。

---

## 7. デプロイ戦略

- **Vercelへのデプロイ:**  
  - GitHubと連携したVercelプロジェクトを構築する。  
  - 本番環境用の環境変数（.env.production）を設定する。  
  - 開発環境のSQLiteから、本番環境向けにSupabase（PostgreSQL）への移行準備を行う。

- **CI/CDパイプライン:**  
  - テストとデプロイプロセスを自動化する。  
  - 本番環境でのエラーログの監視と対応を実施する。

---

## 8. ドキュメント・運用

- **ユーザーおよび開発者向けドキュメント:**  
  - セットアップ手順、使用方法、トラブルシューティングを詳細に記載した`README.md`を作成する。
- **環境変数の例:**  
  - 必要な環境変数を記載した`.env.example`ファイルを提供する。
- **ER図:**  
  - Prisma StudioやERDツールを用いて、データベースのリレーションシップを図示する。
- **運用マニュアル:**  
  - システム監視、エラー対応、バックアップ手順などを文書化する。

---

## 9. マイルストーンとタイムライン

1. **プロジェクト初期設定（1週目）:**  
   - リポジトリの初期化、Next.js設定、Docker環境、基本ツールの導入。
2. **認証とデータベース設定（2週目）:**  
   - Clerkの統合、Prismaによるモデル定義とマイグレーション。
3. **フロントエンドのコア開発（3～4週目）:**  
   - ダッシュボード、銘柄検索・登録、管理者パネルの実装。
4. **バックエンドデータ処理（5～6週目）:**  
   - API連携、データ検証、ログ管理の実装。
5. **テストと品質保証（7週目）:**  
   - ユニット、UI、E2Eテストの実装と実行。
6. **デプロイとドキュメント整備（8週目）:**  
   - Vercelへのデプロイ設定および総合ドキュメントの整備。

---

## 10. リスク考慮事項と課題

- **API制限と障害:**  
  - 外部APIのレートリミットやダウンタイムへの対応として、リトライやフェイルオーバー戦略を実装する必要がある。
- **データ整合性:**  
  - 重複チェックと入力データのバリデーションを厳格に実施し、データ品質を保証する。
- **セキュリティ:**  
  - ユーザーセッションおよびAPIキーの安全な管理を徹底する。
- **スケーラビリティ:**  
  - ユーザー数やデータ量の増加に対応できるよう、バックエンドとデータベースの拡張性を確保する。
- **クロスプラットフォーム互換性:**  
  - 各種デバイスやブラウザで安定したユーザー体験を提供するためのテストを実施する。

---

## 11. 結論

この設計書は、金融データトラッキングダッシュボード（vFinal）のAI実装に向けた詳細な青写真を提供します。明確な要件、システム構成、技術選定、そしてリスク管理の観点から、モジュール化された堅牢なシステムを構築するための道筋を示しています。これにより、実装プロセスは効率的かつ整合性のあるものとなり、今後のメンテナンスや拡張も容易に行えるでしょう。
